// ─── Saubh.Tech Platform — Prisma Schema ────────────────────────────────────
// All models scoped by businessId for multi-tenant safety.
// IDs: cuid(). Timestamps: DateTime with defaults.
// ─────────────────────────────────────────────────────────────────────────────

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public", "master"]
}

// ─── Enums ──────────────────────────────────────────────────────────────────

enum UserRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER

  @@schema("public")
}

enum MemberRole {
  ADMIN
  MEMBER
  OBSERVER

  @@schema("public")
}

enum ConversationType {
  DM
  GROUP
  BROADCAST

  @@schema("public")
}

enum CallDirection {
  INBOUND
  OUTBOUND

  @@schema("public")
}

enum CallStatus {
  INITIATED
  RINGING
  IN_PROGRESS
  COMPLETED
  FAILED
  BUSY
  NO_ANSWER
  CANCELLED

  @@schema("public")
}

// ─── Core Models ────────────────────────────────────────────────────────────

model Business {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clients          Client[]
  memberships      UserMembership[]
  conversations    Conversation[]
  telephonyNumbers TelephonyNumber[]
  telephonyCalls   TelephonyCall[]

  @@index([slug])
  @@schema("public")
}

model Client {
  id         String   @id @default(cuid())
  businessId String
  name       String
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  business         Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  memberships      UserMembership[]
  conversations    Conversation[]
  telephonyNumbers TelephonyNumber[]
  telephonyCalls   TelephonyCall[]

  @@index([businessId])
  @@schema("public")
}

model User {
  id              String   @id @default(cuid())
  email           String   @unique
  keycloakId      String?  @unique
  preferredLocale String   @default("en")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  memberships           UserMembership[]
  conversationMembers   ConversationMember[]
  sentMessages          Message[]

  @@index([email])
  @@index([keycloakId])
  @@schema("public")
}

model UserMembership {
  id         String   @id @default(cuid())
  userId     String
  businessId String
  clientId   String?
  role       UserRole @default(MEMBER)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client   Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@unique([userId, businessId, clientId])
  @@index([userId])
  @@index([businessId])
  @@index([clientId])
  @@schema("public")
}

// ─── Chat Models ────────────────────────────────────────────────────────────

model Conversation {
  id         String           @id @default(cuid())
  businessId String
  clientId   String?
  type       ConversationType @default(DM)
  title      String?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  business Business             @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client   Client?              @relation(fields: [clientId], references: [id], onDelete: SetNull)
  members  ConversationMember[]
  messages Message[]

  @@index([businessId])
  @@index([clientId])
  @@index([businessId, type])
  @@schema("public")
}

model ConversationMember {
  id             String     @id @default(cuid())
  conversationId String
  userId         String
  role           MemberRole @default(MEMBER)
  joinedAt       DateTime   @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([conversationId])
  @@index([userId])
  @@schema("public")
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  senderId       String
  content        String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  conversation Conversation       @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User               @relation(fields: [senderId], references: [id], onDelete: Cascade)
  attachments  MessageAttachment[]

  @@index([conversationId])
  @@index([senderId])
  @@index([conversationId, createdAt])
  @@schema("public")
}

model MessageAttachment {
  id        String   @id @default(cuid())
  messageId String
  objectKey String
  mimeType  String
  size      Int
  createdAt DateTime @default(now())

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@schema("public")
}

// ─── Telephony Models ───────────────────────────────────────────────────────

model TelephonyNumber {
  id               String   @id @default(cuid())
  businessId       String
  clientId         String?
  provider         String
  providerNumberId String
  e164             String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client   Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@unique([provider, providerNumberId])
  @@index([businessId])
  @@index([clientId])
  @@index([e164])
  @@schema("public")
}

model TelephonyCall {
  id             String        @id @default(cuid())
  businessId     String
  clientId       String?
  direction      CallDirection
  from           String
  to             String
  status         CallStatus    @default(INITIATED)
  startedAt      DateTime      @default(now())
  endedAt        DateTime?
  providerCallId String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  business Business         @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client   Client?          @relation(fields: [clientId], references: [id], onDelete: SetNull)
  events   TelephonyEvent[]

  @@index([businessId])
  @@index([clientId])
  @@index([providerCallId])
  @@index([businessId, status])
  @@schema("public")
}

model TelephonyEvent {
  id        String   @id @default(cuid())
  callId    String
  eventType String
  payload   Json     @default("{}")
  createdAt DateTime @default(now())

  call TelephonyCall @relation(fields: [callId], references: [id], onDelete: Cascade)

  @@index([callId])
  @@index([callId, eventType])
  @@schema("public")
}

// ─── Master Schema: Geographic Hierarchy ────────────────────────────────────

model Country {
  countryCode String @id @map("country_code") @db.Char(2)
  country     String @db.VarChar(100)
  iso3        String @db.Char(3)
  isd         String @db.VarChar(10)
  flag        String @db.VarChar(8)

  states    MasterState[]
  districts District[]
  postals   Postal[]
  places    Place[]

  @@map("country")
  @@schema("master")
}

model MasterState {
  stateid     Int    @id @default(autoincrement())
  state       String @db.VarChar(100)
  stateCode   String @map("state_code") @db.Char(2)
  countryCode String @map("country_code") @db.Char(2)
  region      String? @db.VarChar(100)

  country   Country    @relation(fields: [countryCode], references: [countryCode], onDelete: Cascade)
  districts District[]
  postals   Postal[]
  places    Place[]

  @@index([countryCode])
  @@index([stateCode, countryCode])
  @@map("state")
  @@schema("master")
}

model District {
  districtid  Int    @id @default(autoincrement())
  district    String @db.VarChar(100)
  stateid     Int
  countryCode String @map("country_code") @db.Char(2)

  state   MasterState @relation(fields: [stateid], references: [stateid], onDelete: Cascade)
  country Country     @relation(fields: [countryCode], references: [countryCode], onDelete: Cascade)
  postals Postal[]
  places  Place[]

  @@index([stateid])
  @@index([countryCode])
  @@map("district")
  @@schema("master")
}

model Postal {
  postid      Int    @id @default(autoincrement())
  pincode     String @db.VarChar(10)
  postoffice  String @db.VarChar(150)
  districtid  Int
  stateid     Int
  countryCode String @map("country_code") @db.Char(2)

  district District    @relation(fields: [districtid], references: [districtid], onDelete: Cascade)
  state    MasterState @relation(fields: [stateid], references: [stateid], onDelete: Cascade)
  country  Country     @relation(fields: [countryCode], references: [countryCode], onDelete: Cascade)

  @@index([pincode])
  @@index([districtid])
  @@index([stateid])
  @@index([countryCode])
  @@map("postal")
  @@schema("master")
}

model Place {
  placeid     BigInt @id @default(autoincrement())
  countryCode String @map("country_code") @db.Char(2)
  stateid     Int
  districtid  Int
  pincode     String @db.VarChar(10)
  place       String @db.VarChar(200)
  userid      BigInt?

  country  Country     @relation(fields: [countryCode], references: [countryCode], onDelete: Cascade)
  state    MasterState @relation(fields: [stateid], references: [stateid], onDelete: Cascade)
  district District    @relation(fields: [districtid], references: [districtid], onDelete: Cascade)

  @@index([countryCode])
  @@index([stateid])
  @@index([districtid])
  @@index([pincode])
  @@map("place")
  @@schema("master")
}

// ─── Master Schema: Organizational Hierarchy ────────────────────────────────

model Locality {
  localityid  Int    @id @default(autoincrement())
  locality    String @db.VarChar(200)
  placeid     Int[]  @default([])
  localAgency BigInt? @map("local_agency")

  @@map("locality")
  @@schema("master")
}

model Area {
  areaid     Int    @id @default(autoincrement())
  area       String @db.VarChar(200)
  localityid Int[]  @default([])
  areaAgency BigInt? @map("area_agency")

  @@map("area")
  @@schema("master")
}

model Division {
  divisionid    Int    @id @default(autoincrement())
  division      String @db.VarChar(200)
  areaid        Int[]  @default([])
  divisionAgency BigInt? @map("division_agency")

  @@map("division")
  @@schema("master")
}

model MasterRegion {
  regionid      Int    @id @default(autoincrement())
  region        String @db.VarChar(200)
  divisionid    Int[]  @default([])
  regionAgency  BigInt? @map("region_agency")

  @@map("region")
  @@schema("master")
}

model Zone {
  zoneid     Int    @id @default(autoincrement())
  zoneCode   String @map("zone_code") @db.Char(2)
  zone       String @db.VarChar(200)
  regionid   Int[]  @default([])
  zoneAgency BigInt? @map("zone_agency")

  @@map("zone")
  @@schema("master")
}

// ─── Master Schema: Industry Classification ─────────────────────────────────

model Sector {
  sectorid Int    @id @default(autoincrement())
  sector   String @db.VarChar(200)

  fields  Field[]
  markets Market[]

  @@map("sector")
  @@schema("master")
}

model Field {
  fieldid  Int    @id @default(autoincrement())
  field    String @db.VarChar(200)
  sectorid Int

  sector  Sector   @relation(fields: [sectorid], references: [sectorid], onDelete: Cascade)
  markets Market[]

  @@index([sectorid])
  @@map("field")
  @@schema("master")
}

model Market {
  marketid BigInt @id @default(autoincrement())
  sectorid Int
  fieldid  Int
  p_s_ps   String @map("p_s_ps") @db.Char(2)
  item     String @db.VarChar(200)

  sector Sector @relation(fields: [sectorid], references: [sectorid], onDelete: Cascade)
  field  Field  @relation(fields: [fieldid], references: [fieldid], onDelete: Cascade)

  @@index([sectorid])
  @@index([fieldid])
  @@index([p_s_ps])
  @@map("market")
  @@schema("master")
}

// ─── Master Schema: Reference Data ────────────────────────────────────────

model Language {
  langid    Int     @id @default(autoincrement()) @db.SmallInt
  language  String  @unique @db.VarChar(200)
  locale    String  @unique @db.VarChar(10)
  isActive  Boolean @default(true) @map("is_active")
  isRtl     Boolean @default(false) @map("is_rtl")
  sortOrder Int     @default(0) @map("sort_order")

  @@map("language")
  @@schema("master")
}
