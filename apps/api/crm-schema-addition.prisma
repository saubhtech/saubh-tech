// ─── CRM Schema: Unified Multi-Tenant CRM ──────────────────────────────────
// Tenant = Business (from public schema). Every CRM row scoped by tenantId.
// Channels: WHATSAPP, EMAIL, SMS, VOICE, INSTAGRAM, FACEBOOK, WEBCHAT
// ────────────────────────────────────────────────────────────────────────────

enum CrmChannel {
  WHATSAPP
  EMAIL
  SMS
  VOICE
  INSTAGRAM
  FACEBOOK
  WEBCHAT

  @@schema("crm")
}

enum CrmConvoStatus {
  OPEN
  ASSIGNED
  SNOOZED
  RESOLVED
  CLOSED

  @@schema("crm")
}

enum CrmMsgDirection {
  IN
  OUT

  @@schema("crm")
}

enum CrmMsgStatus {
  QUEUED
  SENT
  DELIVERED
  READ
  FAILED
  BOUNCED

  @@schema("crm")
}

enum CrmActivityType {
  NOTE
  CALL
  EMAIL_SENT
  EMAIL_RECEIVED
  MEETING
  TASK
  STAGE_CHANGE
  ASSIGNMENT

  @@schema("crm")
}

enum CrmDealStatus {
  OPEN
  WON
  LOST
  STALE

  @@schema("crm")
}

model CrmTenant {
  id          String   @id @default(cuid())
  businessId  BigInt   @unique @map("business_id")
  name        String   @db.VarChar(200)
  domain      String?  @db.VarChar(100)
  timezone    String   @default("Asia/Kolkata") @db.VarChar(50)
  settings    Json     @default("{}")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  contacts      CrmContact[]
  conversations CrmConversation[]
  pipelines     CrmPipeline[]
  deals         CrmDeal[]
  campaigns     CrmCampaign[]
  channelConfigs CrmChannelConfig[]

  @@map("crm_tenant")
  @@schema("crm")
}

model CrmChannelConfig {
  id          String     @id @default(cuid())
  tenantId    String     @map("tenant_id")
  channel     CrmChannel
  isEnabled   Boolean    @default(false) @map("is_enabled")
  credentials Json       @default("{}")
  settings    Json       @default("{}")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @default(now()) @updatedAt @map("updated_at")

  tenant CrmTenant @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, channel])
  @@map("crm_channel_config")
  @@schema("crm")
}

model CrmContact {
  id            String   @id @default(cuid())
  tenantId      String   @map("tenant_id")
  phone         String?  @db.VarChar(20)
  email         String?  @db.VarChar(255)
  name          String?  @db.VarChar(200)
  firstName     String?  @map("first_name") @db.VarChar(100)
  lastName      String?  @map("last_name") @db.VarChar(100)
  company       String?  @db.VarChar(200)
  avatarUrl     String?  @map("avatar_url")
  userId        BigInt?  @map("user_id")
  waContactId   String?  @map("wa_contact_id")
  lifecycle     String   @default("NEW") @db.VarChar(20)
  tags          String[] @default([])
  customFields  Json     @default("{}")  @map("custom_fields")
  emailInvalid  Boolean  @default(false) @map("email_invalid")
  phoneInvalid  Boolean  @default(false) @map("phone_invalid")
  optedOutWa    Boolean  @default(false) @map("opted_out_wa")
  optedOutEmail Boolean  @default(false) @map("opted_out_email")
  optedOutSms   Boolean  @default(false) @map("opted_out_sms")
  lastSeenAt    DateTime? @map("last_seen_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at")

  tenant        CrmTenant         @relation(fields: [tenantId], references: [id])
  conversations CrmConversation[]
  deals         CrmDeal[]
  activities    CrmActivity[]
  campaignRecipients CrmCampaignRecipient[]

  @@unique([tenantId, phone])
  @@unique([tenantId, email])
  @@index([tenantId, lifecycle])
  @@index([tenantId, tags])
  @@index([userId])
  @@index([waContactId])
  @@map("crm_contact")
  @@schema("crm")
}

model CrmConversation {
  id            String          @id @default(cuid())
  tenantId      String          @map("tenant_id")
  contactId     String          @map("contact_id")
  channel       CrmChannel
  status        CrmConvoStatus  @default(OPEN)
  assignedTo    BigInt?         @map("assigned_to")
  subject       String?         @db.VarChar(300)
  lastMessageAt DateTime?       @map("last_message_at")
  lastMessagePreview String?    @map("last_message_preview") @db.VarChar(200)
  unreadCount   Int             @default(0) @map("unread_count")
  snoozedUntil  DateTime?       @map("snoozed_until")
  resolvedAt    DateTime?       @map("resolved_at")
  externalId    String?         @map("external_id")
  metadata      Json            @default("{}")
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @default(now()) @updatedAt @map("updated_at")

  tenant   CrmTenant    @relation(fields: [tenantId], references: [id])
  contact  CrmContact   @relation(fields: [contactId], references: [id])
  messages CrmMessage[]

  @@index([tenantId, status])
  @@index([tenantId, channel])
  @@index([tenantId, assignedTo])
  @@index([contactId])
  @@index([lastMessageAt])
  @@index([externalId])
  @@map("crm_conversation")
  @@schema("crm")
}

model CrmMessage {
  id             String         @id @default(cuid())
  conversationId String         @map("conversation_id")
  direction      CrmMsgDirection
  channel        CrmChannel
  body           String?
  htmlBody       String?        @map("html_body")
  subject        String?        @db.VarChar(300)
  mediaUrl       String?        @map("media_url")
  mediaType      String?        @map("media_type") @db.VarChar(50)
  status         CrmMsgStatus   @default(QUEUED)
  deliveryStatus String?        @map("delivery_status") @db.VarChar(30)
  externalId     String?        @map("external_id")
  senderType     String         @default("CONTACT") @map("sender_type") @db.VarChar(10)
  senderId       BigInt?        @map("sender_id")
  metadata       Json           @default("{}")
  sentAt         DateTime       @default(now()) @map("sent_at")
  deliveredAt    DateTime?      @map("delivered_at")
  readAt         DateTime?      @map("read_at")

  conversation CrmConversation @relation(fields: [conversationId], references: [id])

  @@index([conversationId, sentAt])
  @@index([externalId])
  @@index([status])
  @@map("crm_message")
  @@schema("crm")
}

model CrmPipeline {
  id        String   @id @default(cuid())
  tenantId  String   @map("tenant_id")
  name      String   @db.VarChar(100)
  isDefault Boolean  @default(false) @map("is_default")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  tenant CrmTenant      @relation(fields: [tenantId], references: [id])
  stages CrmDealStage[]
  deals  CrmDeal[]

  @@index([tenantId])
  @@map("crm_pipeline")
  @@schema("crm")
}

model CrmDealStage {
  id         String   @id @default(cuid())
  pipelineId String   @map("pipeline_id")
  name       String   @db.VarChar(100)
  position   Int      @default(0)
  color      String   @default("#6B7280") @db.VarChar(10)
  createdAt  DateTime @default(now()) @map("created_at")

  pipeline CrmPipeline @relation(fields: [pipelineId], references: [id])
  deals    CrmDeal[]

  @@index([pipelineId, position])
  @@map("crm_deal_stage")
  @@schema("crm")
}

model CrmDeal {
  id         String        @id @default(cuid())
  tenantId   String        @map("tenant_id")
  contactId  String        @map("contact_id")
  pipelineId String        @map("pipeline_id")
  stageId    String        @map("stage_id")
  title      String        @db.VarChar(300)
  value      Decimal?      @db.Decimal(12, 2)
  currency   String        @default("INR") @db.VarChar(3)
  status     CrmDealStatus @default(OPEN)
  ownerId    BigInt?       @map("owner_id")
  expectedCloseAt DateTime? @map("expected_close_at")
  closedAt   DateTime?     @map("closed_at")
  lostReason String?       @map("lost_reason") @db.VarChar(300)
  metadata   Json          @default("{}")
  createdAt  DateTime      @default(now()) @map("created_at")
  updatedAt  DateTime      @default(now()) @updatedAt @map("updated_at")

  tenant   CrmTenant    @relation(fields: [tenantId], references: [id])
  contact  CrmContact   @relation(fields: [contactId], references: [id])
  pipeline CrmPipeline  @relation(fields: [pipelineId], references: [id])
  stage    CrmDealStage @relation(fields: [stageId], references: [id])

  @@index([tenantId, status])
  @@index([tenantId, stageId])
  @@index([contactId])
  @@map("crm_deal")
  @@schema("crm")
}

model CrmActivity {
  id        String          @id @default(cuid())
  contactId String          @map("contact_id")
  type      CrmActivityType
  title     String          @db.VarChar(300)
  body      String?
  agentId   BigInt?         @map("agent_id")
  metadata  Json            @default("{}")
  createdAt DateTime        @default(now()) @map("created_at")

  contact CrmContact @relation(fields: [contactId], references: [id])

  @@index([contactId, createdAt])
  @@index([type])
  @@map("crm_activity")
  @@schema("crm")
}

model CrmCampaign {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  name        String   @db.VarChar(200)
  channel     CrmChannel
  type        String   @default("BROADCAST") @db.VarChar(20)
  status      String   @default("DRAFT") @db.VarChar(20)
  body        String?
  htmlBody    String?  @map("html_body")
  subject     String?  @db.VarChar(300)
  templateId  String?  @map("template_id")
  segment     Json     @default("{}")
  scheduledAt DateTime? @map("scheduled_at")
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")
  stats       Json     @default("{}") @map("stats")
  createdBy   BigInt?  @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  tenant     CrmTenant              @relation(fields: [tenantId], references: [id])
  recipients CrmCampaignRecipient[]

  @@index([tenantId, status])
  @@index([channel])
  @@map("crm_campaign")
  @@schema("crm")
}

model CrmCampaignRecipient {
  id         String    @id @default(cuid())
  campaignId String    @map("campaign_id")
  contactId  String    @map("contact_id")
  status     String    @default("PENDING") @db.VarChar(20)
  externalId String?   @map("external_id")
  sentAt     DateTime? @map("sent_at")
  openedAt   DateTime? @map("opened_at")
  clickedAt  DateTime? @map("clicked_at")

  campaign CrmCampaign @relation(fields: [campaignId], references: [id])
  contact  CrmContact  @relation(fields: [contactId], references: [id])

  @@index([campaignId])
  @@index([contactId])
  @@index([status])
  @@map("crm_campaign_recipient")
  @@schema("crm")
}

