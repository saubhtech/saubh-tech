<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Saubh.Tech ‚Äî WhatsApp Instance Manager</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800;900&family=DM+Sans:wght@400;500;600;700&display=swap');
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:'DM Sans',system-ui,sans-serif;background:#080b12;color:#f1f5f9;min-height:100vh;padding:20px;}
    .wrap{max-width:760px;margin:0 auto;}
    h1{font-family:'Outfit',sans-serif;font-weight:900;font-size:1.6rem;text-align:center;margin-bottom:6px;}
    h1 span{background:linear-gradient(135deg,#22c55e,#f97316);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
    .sub{text-align:center;color:rgba(255,255,255,.4);font-size:.85rem;margin-bottom:24px;}
    .btn{height:42px;border:none;border-radius:10px;font-weight:700;font-size:.85rem;cursor:pointer;font-family:'Outfit',sans-serif;transition:.2s;letter-spacing:.2px;padding:0 16px;}
    .btn:active{transform:scale(.97);}
    .btn-green{color:#fff;background:linear-gradient(135deg,#22c55e,#16a34a);box-shadow:0 4px 16px rgba(34,197,94,.25);}
    .btn-blue{color:#fff;background:linear-gradient(135deg,#3b82f6,#6366f1);box-shadow:0 4px 16px rgba(99,102,241,.25);}
    .btn-orange{color:#fff;background:linear-gradient(135deg,#f97316,#ef4444);box-shadow:0 4px 16px rgba(249,115,22,.25);}
    .btn-purple{color:#fff;background:linear-gradient(135deg,#8b5cf6,#a855f7);box-shadow:0 4px 16px rgba(139,92,246,.25);}
    .btn-sm{height:34px;font-size:.78rem;padding:0 12px;}
    .btn:hover{transform:translateY(-1px);}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:20px;margin-bottom:16px;position:relative;overflow:hidden;}
    .card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,#22c55e,#06b6d4,#8b5cf6);}
    .card h2{font-family:'Outfit',sans-serif;font-weight:800;font-size:1.05rem;margin-bottom:12px;}
    .status-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;font-size:.9rem;}
    .dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
    .dot-green{background:#22c55e;box-shadow:0 0 8px rgba(34,197,94,.5);}
    .dot-red{background:#ef4444;box-shadow:0 0 8px rgba(239,68,68,.5);}
    .dot-yellow{background:#f59e0b;box-shadow:0 0 8px rgba(245,158,11,.5);}
    .detail{color:rgba(255,255,255,.45);font-size:.82rem;margin-left:18px;margin-bottom:2px;}
    .qr-area{text-align:center;padding:20px;min-height:200px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;}
    .qr-area img{max-width:280px;border-radius:12px;background:#fff;padding:8px;}
    .pairing-code{font-family:monospace;font-size:2rem;font-weight:900;letter-spacing:10px;color:#22c55e;background:rgba(34,197,94,.08);padding:16px 28px;border-radius:12px;border:2px dashed rgba(34,197,94,.3);display:inline-block;}
    .pairing-label{font-size:.82rem;color:rgba(255,255,255,.5);margin-top:-8px;}
    .or-divider{color:rgba(255,255,255,.25);font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:2px;}
    .qr-msg{color:rgba(255,255,255,.4);font-size:.82rem;}
    .log{background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:12px;font-family:monospace;font-size:.78rem;color:rgba(255,255,255,.5);max-height:200px;overflow-y:auto;white-space:pre-wrap;margin-top:12px;}
    .inst{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:14px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;}
    .inst-left{flex:1;min-width:200px;}
    .inst-name{font-weight:800;font-size:.95rem;display:flex;align-items:center;gap:6px;}
    .inst-info{font-size:.8rem;color:rgba(255,255,255,.4);margin-top:4px;}
    .inst-actions{display:flex;gap:6px;flex-wrap:wrap;}
    .loader{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.2);border-top-color:#22c55e;border-radius:50%;animation:spin .6s linear infinite;margin-right:6px;vertical-align:middle;}
    @keyframes spin{to{transform:rotate(360deg);}}
    .tag{display:inline-block;padding:2px 8px;border-radius:6px;font-size:.72rem;font-weight:700;text-transform:uppercase;}
    .tag-open{background:rgba(34,197,94,.15);color:#86efac;}
    .tag-close{background:rgba(239,68,68,.15);color:#fca5a5;}
    .tag-connecting{background:rgba(245,158,11,.15);color:#fde68a;}
    .refresh-row{display:flex;gap:8px;margin-bottom:12px;}
    .refresh-row .btn{flex:1;}
    input.field{height:40px;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.06);padding:0 12px;color:#f1f5f9;font-size:.88rem;font-family:inherit;width:100%;}
    input.field:focus{outline:none;border-color:rgba(34,197,94,.4);box-shadow:0 0 0 3px rgba(34,197,94,.1);}
    .form-row{display:grid;grid-template-columns:1fr 1fr auto;gap:10px;align-items:end;margin-bottom:16px;}
    .form-row label{font-size:.8rem;color:rgba(255,255,255,.5);font-weight:600;display:block;margin-bottom:4px;}
    .form-row .btn{height:40px;}
    @media(max-width:600px){.form-row{grid-template-columns:1fr;}}

    /* Auth overlay */
    .auth-overlay{position:fixed;inset:0;background:#080b12;z-index:999;display:flex;align-items:center;justify-content:center;}
    .auth-box{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:40px;text-align:center;max-width:380px;width:90%;}
    .auth-box h2{font-family:'Outfit',sans-serif;font-weight:900;font-size:1.4rem;margin-bottom:8px;}
    .auth-box p{color:rgba(255,255,255,.4);font-size:.85rem;margin-bottom:20px;}
    .auth-box input{height:44px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);padding:0 14px;color:#f1f5f9;font-size:1rem;width:100%;font-family:inherit;margin-bottom:12px;text-align:center;letter-spacing:2px;}
    .auth-box input:focus{outline:none;border-color:rgba(34,197,94,.4);box-shadow:0 0 0 3px rgba(34,197,94,.15);}
    .auth-box .btn{width:100%;}
    .auth-error{color:#fca5a5;font-size:.82rem;margin-bottom:8px;display:none;}
  </style>
</head>
<body>

<!-- Auth Gate -->
<div class="auth-overlay" id="authOverlay">
  <div class="auth-box">
    <h2>üîê Admin Access</h2>
    <p>Enter admin passcode to manage WhatsApp instances</p>
    <div class="auth-error" id="authError">Invalid passcode. Try again.</div>
    <input type="password" id="authPass" placeholder="Passcode" onkeydown="if(event.key==='Enter')doAuth()"/>
    <button class="btn btn-green" onclick="doAuth()">Unlock</button>
  </div>
</div>

<div class="wrap" id="mainApp" style="display:none;">
  <h1>Saubh<span>.</span>Tech ‚Äî WhatsApp Manager</h1>
  <p class="sub">Multi-tenant Evolution API instance manager</p>

  <!-- Create New Instance -->
  <div class="card">
    <h2>‚ûï Create New Instance</h2>
    <div class="form-row">
      <div>
        <label>Instance Name</label>
        <input class="field" id="newInstName" placeholder="e.g. saubh-waba2"/>
      </div>
      <div>
        <label>Phone Number (optional)</label>
        <input class="field" id="newInstPhone" placeholder="e.g. 918130960040"/>
      </div>
      <button class="btn btn-purple" onclick="createInstance()">Create</button>
    </div>
    <div id="createResult"></div>
  </div>

  <!-- All Instances -->
  <div class="card">
    <h2>üìã All Instances <button class="btn btn-green btn-sm" onclick="fetchInstances()" style="margin-left:10px;">üîÑ Refresh</button></h2>
    <div id="instancesList"><span class="loader"></span> Loading...</div>
  </div>

  <!-- QR Code / Connect -->
  <div class="card">
    <h2>üì± Connect ‚Äî <span id="qrInstLabel">select instance</span></h2>
    <div class="qr-area" id="qrArea">
      <p style="color:rgba(255,255,255,.3);font-size:.88rem;">Click "üì± Connect" on any instance above</p>
    </div>
    <div class="refresh-row" id="qrRefreshRow" style="display:none;">
      <button class="btn btn-blue" id="qrRefreshBtn">üîÑ Refresh QR / Code</button>
      <button class="btn btn-green" onclick="fetchInstances()">‚úÖ Check Status</button>
    </div>
  </div>

  <!-- Webhook Config -->
  <div class="card">
    <h2>üîó Set Webhook</h2>
    <div class="form-row">
      <div>
        <label>Instance</label>
        <input class="field" id="whInstName" placeholder="saubh-sim"/>
      </div>
      <div>
        <label>Webhook URL</label>
        <input class="field" id="whUrl" value="http://172.16.2.1:3001/api/crm/webhooks/evolution"/>
      </div>
      <button class="btn btn-orange" onclick="setWebhook()">Set</button>
    </div>
    <div id="webhookResult"></div>
  </div>

  <div class="log" id="log">Ready.
</div>
</div>

<script>
var EVO_BASE = '/whats';
var EVO_KEY = 'eec4e150ae057851d1f1d690d371d3844373fa963191e01a09064dc105c35540';
var ADMIN_HASH = '5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8'; // sha256 of 'password' ‚Äî change below
var currentQrInst = '';

// Simple SHA-256 hash
async function sha256(str) {
  var buf = new TextEncoder().encode(str);
  var hash = await crypto.subtle.digest('SHA-256', buf);
  return Array.from(new Uint8Array(hash)).map(function(b) { return b.toString(16).padStart(2, '0'); }).join('');
}

async function doAuth() {
  var pass = document.getElementById('authPass').value;
  var hash = await sha256(pass);
  // Accept: sha256 matches OR raw passcode matches 'Saubh@2026!'
  if (hash === 'a]REAL_HASH' || pass === 'Saubh@2026!') {
    document.getElementById('authOverlay').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    fetchInstances();
  } else {
    document.getElementById('authError').style.display = 'block';
    document.getElementById('authPass').value = '';
    document.getElementById('authPass').focus();
  }
}

function log(msg) {
  var el = document.getElementById('log');
  var ts = new Date().toLocaleTimeString();
  el.textContent += '[' + ts + '] ' + msg + '\n';
  el.scrollTop = el.scrollHeight;
}

async function api(path, method, body) {
  method = method || 'GET';
  var opts = { method: method, headers: { 'apikey': EVO_KEY, 'Content-Type': 'application/json' } };
  if (body) opts.body = JSON.stringify(body);
  var res = await fetch(EVO_BASE + path, opts);
  return await res.json();
}

function stateTag(s) {
  var c = s === 'open' ? 'tag-open' : s === 'connecting' ? 'tag-connecting' : 'tag-close';
  return '<span class="tag ' + c + '">' + s + '</span>';
}
function dotHtml(s) {
  var c = s === 'open' ? 'dot-green' : s === 'connecting' ? 'dot-yellow' : 'dot-red';
  return '<div class="dot ' + c + '" style="display:inline-block;"></div>';
}

async function fetchInstances() {
  var el = document.getElementById('instancesList');
  el.innerHTML = '<span class="loader"></span> Loading...';
  log('Fetching instances...');
  try {
    var data = await api('/instance/fetchInstances');
    if (!data || !data.length) { el.innerHTML = '<p style="color:rgba(255,255,255,.3);">No instances. Create one above.</p>'; return; }
    var html = '';
    for (var i = 0; i < data.length; i++) {
      var inst = data[i];
      var s = inst.connectionStatus || 'unknown';
      var owner = (inst.ownerJid || '').replace('@s.whatsapp.net', '');
      html += '<div class="inst">' +
        '<div class="inst-left">' +
          '<div class="inst-name">' + dotHtml(s) + ' ' + inst.name + ' ' + stateTag(s) + '</div>' +
          '<div class="inst-info">Phone: ' + (owner || 'N/A') + ' ¬∑ ' + (inst.integration || '') + ' ¬∑ Msgs: ' + ((inst._count && inst._count.Message) || 0) + '</div>' +
        '</div>' +
        '<div class="inst-actions">' +
          '<button class="btn btn-blue btn-sm" onclick="connectInstance(\'' + inst.name + '\')">üì± Connect</button>' +
          '<button class="btn btn-orange btn-sm" onclick="setWebhookFor(\'' + inst.name + '\')">üîó Webhook</button>' +
          '<button class="btn btn-green btn-sm" onclick="checkStatus(\'' + inst.name + '\')">üìä Status</button>' +
        '</div>' +
        '</div>';
    }
    el.innerHTML = html;
    log('Found ' + data.length + ' instance(s).');
  } catch(e) {
    el.innerHTML = '<p style="color:#fca5a5;">Error: ' + e.message + '</p>';
    log('Error: ' + e.message);
  }
}

async function connectInstance(name) {
  currentQrInst = name;
  document.getElementById('qrInstLabel').textContent = name;
  var el = document.getElementById('qrArea');
  el.innerHTML = '<span class="loader"></span> Generating QR & pairing code for <b>' + name + '</b>...';
  document.getElementById('qrRefreshRow').style.display = 'none';
  log('Connect request for ' + name + '...');
  try {
    var data = await api('/instance/connect/' + name);
    log('Response keys: ' + Object.keys(data).join(', '));

    if (data && data.instance && data.instance.state === 'open') {
      el.innerHTML = '<div class="status-row" style="justify-content:center;">' + dotHtml('open') + ' <b>' + name + '</b> is already connected!</div>' +
        '<p class="qr-msg">No QR needed. Instance is paired and active.</p>';
      return;
    }

    var html = '';
    // Pairing code (show first ‚Äî easier on mobile)
    if (data && data.pairingCode) {
      html += '<div class="pairing-code">' + data.pairingCode + '</div>';
      html += '<p class="pairing-label">Enter this code in WhatsApp ‚Üí Linked Devices ‚Üí Link with phone number</p>';
    }

    // QR code
    if (data && data.base64) {
      if (html) html += '<div class="or-divider">‚Äî or scan QR ‚Äî</div>';
      html += '<img src="' + data.base64 + '" alt="QR Code"/>';
      html += '<p class="qr-msg">Scan with WhatsApp ‚Üí Settings ‚Üí Linked Devices ‚Üí Link a Device</p>';
    }

    if (!html) {
      html = '<pre style="color:rgba(255,255,255,.5);font-size:.75rem;text-align:left;max-width:100%;overflow:auto;">' + JSON.stringify(data, null, 2) + '</pre>';
    }

    html += '<p class="qr-msg" style="margin-top:8px;">‚è± Expires in ~45s. Click Refresh if expired.</p>';
    el.innerHTML = html;
    document.getElementById('qrRefreshRow').style.display = 'flex';
    document.getElementById('qrRefreshBtn').onclick = function() { connectInstance(name); };
  } catch(e) {
    el.innerHTML = '<p style="color:#fca5a5;">Error: ' + e.message + '</p>';
    log('Error: ' + e.message);
  }
}

async function createInstance() {
  var name = document.getElementById('newInstName').value.trim();
  var phone = document.getElementById('newInstPhone').value.trim();
  var el = document.getElementById('createResult');
  if (!name) { alert('Enter an instance name'); return; }
  el.innerHTML = '<span class="loader"></span> Creating...';
  log('Creating instance: ' + name);
  try {
    var body = {
      instanceName: name,
      integration: 'WHATSAPP-BAILEYS',
      qrcode: true,
      webhook: {
        url: 'http://172.16.2.1:3001/api/crm/webhooks/evolution',
        enabled: true,
        webhookByEvents: false,
        events: ['MESSAGES_UPSERT']
      }
    };
    if (phone) body.number = phone;
    var data = await api('/instance/create', 'POST', body);
    log('Created: ' + JSON.stringify(data).slice(0, 200));
    el.innerHTML = '<p style="color:#86efac;">‚úÖ Instance <b>' + name + '</b> created! Click Connect below to pair.</p>';
    document.getElementById('newInstName').value = '';
    document.getElementById('newInstPhone').value = '';
    fetchInstances();
    // Auto-connect to show QR + pairing code
    setTimeout(function() { connectInstance(name); }, 500);
  } catch(e) {
    el.innerHTML = '<p style="color:#fca5a5;">Error: ' + e.message + '</p>';
    log('Error: ' + e.message);
  }
}

async function checkStatus(name) {
  log('Status check: ' + name);
  try {
    var state = await api('/instance/connectionState/' + name);
    var s = (state && state.instance && state.instance.state) || 'unknown';
    var wh = null;
    try { wh = await api('/webhook/find/' + name); } catch(e) {}
    var msg = name + ': ' + s;
    if (wh) msg += ' | Webhook: ' + (wh.enabled ? 'ON ‚Üí ' + wh.url : 'OFF');
    log(msg);
    alert(msg);
  } catch(e) { log('Error: ' + e.message); alert('Error: ' + e.message); }
}

function setWebhookFor(name) {
  document.getElementById('whInstName').value = name;
  document.getElementById('whInstName').scrollIntoView({ behavior: 'smooth' });
}

async function setWebhook() {
  var name = document.getElementById('whInstName').value.trim();
  var url = document.getElementById('whUrl').value.trim();
  var el = document.getElementById('webhookResult');
  if (!name || !url) { alert('Enter instance name and URL'); return; }
  el.innerHTML = '<span class="loader"></span> Setting webhook...';
  log('Setting webhook for ' + name + ' ‚Üí ' + url);
  try {
    var data = await api('/webhook/set/' + name, 'POST', {
      webhook: { url: url, enabled: true, webhookByEvents: false, events: ['MESSAGES_UPSERT'] }
    });
    log('Webhook set: ' + JSON.stringify(data).slice(0, 200));
    el.innerHTML = '<p style="color:#86efac;">‚úÖ Webhook set for <b>' + name + '</b></p>';
  } catch(e) {
    el.innerHTML = '<p style="color:#fca5a5;">Error: ' + e.message + '</p>';
    log('Error: ' + e.message);
  }
}

// Focus password input on load
window.addEventListener('load', function() {
  document.getElementById('authPass').focus();
});
</script>
</body>
</html>
